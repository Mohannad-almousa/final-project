<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dashboard ‚Äî Research Quest</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="TemplateData/style.css" />
  <style>
    :root {
      --bg: #f7f7ef;
      --card: #fafafa;
      --accent: #442C93;
      --muted: #6b6b6b;
      --highlight: #D1E231;
      --shadow: rgba(0, 0, 0, 0.15);
    }

    body {
      margin: 0;
      font-family: "Georgia", serif;
      background: var(--bg);
      color: #111;
      padding: 24px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* ======= NAVBAR ======= */
    header.site-header {
      display: flex;
      justify-content: center; /* Center the header content */
      align-items: center;
      padding: 14px 50px;
      background: #442C93; /* Set to dark purple like the second image */
      border-radius: 8px;
      margin-bottom: 20px;
    }

    header .nav {
      display: flex;
      gap: 30px;
      justify-content: center;
      width: 100%;
    }

    header .nav a {
      text-decoration: none;
      color: #fff;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background 0.3s;
    }

    /* Active and hover link styles */
    header .nav a.active,
    header .nav a:hover {
      background: #D1E231; /* Green color for active links */
      color: #1c0b3a; /* Dark color for active links */
    }

    .user-stats {
      display: flex;
      gap: 24px;
      align-items: center;
      color: var(--muted);
    }

    .hero {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }

    .welcome {
      flex: 1;
      background: var(--card);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 6px 18px var(--shadow);
    }

    .welcome h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
    }

    .summary-cards {
      display: flex;
      gap: 12px;
      width: 360px;
    }

    .card {
      background: var(--accent);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 6px 18px var(--shadow);
    }

    .card .num {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      align-items: start;
    }

    .panel {
      background: var(--card);
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 6px 18px var(--shadow);
    }

    .progress-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
    }

    .progress-row .meta {
      width: 120px;
      font-weight: 600;
    }

    .progress-bar {
      flex: 1;
      height: 12px;
      background: #eee;
      border-radius: 8px;
      overflow: hidden;
    }

    .progress-bar > i {
      display: block;
      height: 100%;
      background: var(--highlight);
      width: 0%; /* Dynamic width */
    }

    .small-card {
      background: #f6eef6;
      padding: 14px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .small-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    th {
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }

    .week-stats {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* =========================== Chat Icon =========================== */
    .chat-icon {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 55px;
      height: 55px;
      background-color: #442C93;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
      z-index: 1000;
    }

    /* =========================== Chat Wrapper =========================== */
    .chat-wrapper {
      position: fixed;
      bottom: 95px;
      right: 30px;
      width: 320px;
      height: 480px;
      background: #fafafa;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 999;
    }

    /* =========================== Chat Header =========================== */
    .chat-header {
      background: #442C93;
      padding: 14px 18px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header-title {
      font-size: 15px;
      font-weight: 700;
    }

    .chat-header-sub {
      font-size: 12px;
      opacity: 0.8;
    }

    .close-btn {
      cursor: pointer;
      font-size: 20px;
    }

    #chatBox {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f7f7f0;
    }

    .msg {
      max-width: 85%;
      padding: 12px 14px;
      border-radius: 16px;
      margin-bottom: 12px;
      font-size: 14px;
      line-height: 1.4;
    }

    .msg.user {
      background: #442C93;
      color: white;
      align-self: flex-end;
    }

    .msg.bot {
      background: #e6e6e6;
      color: #333;
      align-self: flex-start;
    }

    /* =========================== Input Area =========================== */
    .input-area {
      padding: 12px;
      display: flex;
      gap: 10px;
      border-top: 1px solid #ddd;
      background: #f0f0f0;
    }

    #chatInput {
      flex: 1;
      padding: 10px 14px;
      border-radius: 20px;
      border: none;
      outline: none;
    }

    .send-btn {
      width: 40px;
      height: 40px;
      background: #442C93;
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }

    .send-btn:hover {
      background: #1d2d44;
    }

  </style>
</head>

<body>

  <div class="container">
    <header class="site-header">
      <div class="nav">
        
        <a href="home.html">Home</a>
        <a href="dashboard.html" style="color: var(--highlight)">Dashboard</a>
        <a href="modules.html">Modules</a>
        
      </div>
      <div class="user-stats">
        <div id="top-total-points">--</div>
        <div id="top-badges">--</div>
        <div id="top-modules">--</div>
      </div>
    </header>

    <div class="hero">
      <div class="welcome">
        <h2 id="welcome-title">Welcome Back!</h2>
        <p id="welcome-sub">You're making great progress. Keep it up!</p>
      </div>
      <div class="summary-cards">
        <div class="card">
          <div style="font-size: 12px; color: var(--muted)">Total Points</div>
          <div class="num" id="card-total-points">--</div>
        </div>
        <div class="card">
          <div style="font-size: 12px; color: var(--muted)">Badges</div>
          <div class="num" id="card-badges">--</div>
        </div>
        <div class="card">
          <div style="font-size: 12px; color: var(--muted)">Modules Done</div>
          <div class="num" id="card-modules-done">--</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="panel">
          <h3>Your Progress</h3>
          <div class="progress-row">
            <div class="meta">Beginner</div>
            <div class="progress-bar">
              <i id="bar-beginner"></i>
            </div>
            <div style="width: 70px; text-align: right" id="txt-beginner">0%</div>
          </div>
          <div class="progress-row">
            <div class="meta">Intermediate</div>
            <div class="progress-bar">
              <i id="bar-intermediate"></i>
            </div>
            <div style="width: 70px; text-align: right" id="txt-intermediate">0%</div>
          </div>
          <div class="progress-row">
            <div class="meta">Advanced</div>
            <div class="progress-bar">
              <i id="bar-advanced"></i>
            </div>
            <div style="width: 70px; text-align: right" id="txt-advanced">0%</div>
          </div>
        </div>
        <div class="panel" style="margin-top: 18px;">
          <h3>Recent Sessions</h3>
          <div style="max-height: 300px; overflow: auto;">
            <table id="sessions-table">
              <thead>
                <tr>
                  <th>When</th>
                  <th>Lesson</th>
                  <th>Score</th>
                  <th>Errors</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div>
        <div class="panel small-card">
          <h4>Points and Achievements</h4>
          <div class="small-row">
            <div>Total Points</div>
            <div id="right-total-points">--</div>
          </div>
          <div class="small-row">
            <div>Badges</div>
            <div id="right-badges">--</div>
          </div>
          <div class="small-row">
            <div>Completion Rate</div>
            <div id="right-completion">--</div>
          </div>
        </div>
        <div class="panel small-card">
          <h4>This Week</h4>
          <div class="week-stats">
            <div class="small-row">
              <div>Study Time</div>
              <div id="week-time">--</div>
            </div>
            <div class="small-row">
              <div>Modules Started</div>
              <div id="week-modules">--</div>
            </div>
            <div class="small-row">
              <div>Points Earned</div>
              <div id="week-points">--</div>
            </div>
            <div class="small-row">
              <div>Streak</div>
              <div id="week-streak">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= FIREBASE DASHBOARD SCRIPT ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS6WZ13DKVvbdddE-azZrI2FuBrSe39u0",
      authDomain: "login-1aba2.firebaseapp.com",
      projectId: "login-1aba2",
      storageBucket: "login-1aba2.appspot.com",
      messagingSenderId: "393759404087",
      appId: "1:393759404087:web:9581fde1afb9ca81decfb2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const PASS_THRESHOLD = 70;
    const beginnerLevels = ["Beginner_Categorize_1", "Beginner_Categorize_2", "Beginner_Categorize_3"];
    const intermediateLevels = ["Intermediate_Sort_1", "Intermediate_Sort_2", "Intermediate_Sort_3"];
    const advancedLevels = ["Advanced_Analyze_1", "Advanced_Analyze_2", "Advanced_Analyze_3"];
    const ALL_LESSONS = [...beginnerLevels, ...intermediateLevels, ...advancedLevels];

    // ======== ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ========
    function formatSecondsToHM(seconds){
      if(!seconds || seconds <= 0) return "0s";
      const h = Math.floor(seconds / 3600), m = Math.floor((seconds % 3600) / 60), s = Math.floor(seconds % 60);
      return (h ? h + "h " : "") + (m ? m + "m " : "") + (!h && !m ? s + "s" : "");
    }

    function calculateStreak(daysSet){
      if(!daysSet || daysSet.size === 0) return 0;
      let streak = 0;
      let cursor = new Date();
      while(true){
        const iso = cursor.toISOString().slice(0, 10);
        if(daysSet.has(iso)){ streak++; cursor.setDate(cursor.getDate() - 1); }
        else break;
      }
      return streak;
    }

    // ======== ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ========
    onAuthStateChanged(auth, async (user) => {
      if(!user){ window.location.href = "login.html"; return; }
      const uid = user.uid;
      document.getElementById("welcome-title").innerText = `Welcome Back, ${user.displayName || user.email?.split('@')[0]}!`;
      await renderDashboardForUser(uid);
    });

    // ======== ÿ¨ŸÑÿ® Ÿàÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ========
    async function renderDashboardForUser(uid) {
      try {
        const sessionsQuery = query(
          collection(db, "Sessions"),
          where("uid", "==", uid),
          orderBy("createdAt", "desc")
        );
        const sessionsSnap = await getDocs(sessionsQuery);

        // ======== ÿ•ÿπÿØÿßÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÇÿØŸÖ ========
        const progressData = {};
        sessionsSnap.forEach(docSnap => {
          const s = docSnap.data();
          const lesson = s.lessonID || s.lesson_id;
          const created = s.createdAt?.toDate?.() || new Date(); // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ createdAt
          if (!lesson || typeof s.score !== "number") return;
          // ÿ™ÿÆÿ≤ŸäŸÜ ÿ¢ÿÆÿ± session ŸÑŸÉŸÑ ÿØÿ±ÿ≥
          if (!progressData[lesson] || created > progressData[lesson].created) {
            progressData[lesson] = { ...s, created };
          }
        });

        // ======== ÿ≠ÿ≥ÿßÿ® ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ========
        let totalPoints = 0, modulesDone = 0;
        for (const lesson of ALL_LESSONS) {
          const rec = progressData[lesson];
          if (rec) { totalPoints += rec.score; if (rec.score >= PASS_THRESHOLD) modulesDone++; }
        }

        document.getElementById("top-total-points").innerText = `Points: ${totalPoints}`;
        document.getElementById("top-modules").innerText = `Done: ${modulesDone}`;
        document.getElementById("card-total-points").innerText = totalPoints;
        document.getElementById("card-modules-done").innerText = modulesDone;

        function calcProgress(levels){
          let done = 0;
          for (const l of levels) if (progressData[l] && progressData[l].score >= PASS_THRESHOLD) done++;
          return { done, percent: Math.round(done / levels.length * 100) };
        }

        const beg = calcProgress(beginnerLevels), mid = calcProgress(intermediateLevels), adv = calcProgress(advancedLevels);
        document.getElementById("bar-beginner").style.width = `${beg.percent}%`;
        document.getElementById("txt-beginner").innerText = `${beg.percent}% (${beg.done}/${beginnerLevels.length})`;
        document.getElementById("bar-intermediate").style.width = `${mid.percent}%`;
        document.getElementById("txt-intermediate").innerText = `${mid.percent}% (${mid.done}/${intermediateLevels.length})`;
        document.getElementById("bar-advanced").style.width = `${adv.percent}%`;
        document.getElementById("txt-advanced").innerText = `${adv.percent}% (${adv.done}/${advancedLevels.length})`;

        document.getElementById("right-total-points").innerText = totalPoints;
        document.getElementById("right-completion").innerText = `${Math.round(modulesDone / ALL_LESSONS.length * 100)}%`;

        // ======== ÿπÿ±ÿ∂ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ========
        const tbody = document.querySelector("#sessions-table tbody");
        tbody.innerHTML = "";
        let weekSeconds = 0, weekPoints = 0;
        const modulesSet = new Set(), daysSet = new Set();
        const now = new Date(), sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

        sessionsSnap.forEach(docSnap => {
          const s = docSnap.data();
          const created = s.createdAt?.toDate?.() || new Date(); // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ createdAt
          const lesson = s.lessonID || s.lesson_id || "‚Äî";
          const score = s.score || 0, errors = s.errors || 0, timeSpent = s.timeSpent || 0;
          modulesSet.add(lesson);
          if (created >= sevenDaysAgo) { weekSeconds += timeSpent; weekPoints += score; }
          daysSet.add(created.toISOString().slice(0, 10));
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${created.toLocaleString()}</td><td>${lesson}</td><td>${score}</td><td>${errors}</td><td>${formatSecondsToHM(timeSpent)}</td>`;
          tbody.appendChild(tr);
        });

        document.getElementById("week-time").innerText = formatSecondsToHM(weekSeconds);
        document.getElementById("week-modules").innerText = modulesSet.size;
        document.getElementById("week-points").innerText = weekPoints;
        document.getElementById("week-streak").innerText = `${calculateStreak(daysSet)} days`;

        console.log("‚úÖ Dashboard rendered for user", uid);
      } catch (err) { console.error("‚ùå Error rendering dashboard:", err); }
    }
  </script>
  <!-- ================= CHATBOT ================= -->
<div class="chat-icon" onclick="toggleChatbot()">üí¨</div>

<div class="chat-wrapper" id="chatWrapper">
  <div class="chat-header">
    <div>
      <div class="chat-header-title">Research Assistant</div>
      <div class="chat-header-sub">Always here to help</div>
    </div>
    <div class="close-btn" onclick="toggleChatbot()">√ó</div>
  </div>

  <div id="chatBox"></div>

  <div class="input-area">
    <input type="text" id="chatInput" placeholder="Ask me anything...">
    <button class="send-btn" id="sendBtn">‚û§</button>
  </div>
</div>

<script src="chatbot.js"></script>

</body>
</html>
